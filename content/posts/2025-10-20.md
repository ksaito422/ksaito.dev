+++
date = '2025-10-20T11:33:47+09:00'
draft = false
title = 'RSpecのdefine_negated_matcherでカスタムマッチャーの否定形を定義する'
tags = []
author = 'ksaito'
description = ''
searchHidden = true
+++

RSpecの`define_negated_matcher`を使うと、カスタムマッチャーの否定形を簡単に定義できます。
`not_to`が使えないような複合条件のケースを作成する際に便利です。

このようなケースを想定しています。
```ruby
RSpec.describe [1, 2, 3] do
  it '' do
    lists = subject.dup
    expect { lists.delete(2) }.to change { lists }.not_to include(2)
  end
end
```

実行すると、次のエラーが発生します。

```
NotImplementedError:
  `expect { }.not_to change { }.to()` is not supported
```

このようなケースでは次のように書けば変わらんだろうというツッコミはさておき、直接的に検証したい場合は、`define_negated_matcher`を使って否定形のマッチャーを定義することで解決できます。
```ruby
expect { lists.delete(2) }.to change { lists }.to contain_exactly(1, 3)
```

## 使い方

```ruby
RSpec::Matchers.define_negated_matcher :an_array_excluding, :include

RSpec.describe [1, 2, 3] do
  it '' do
    lists = subject.dup
    expect { lists.delete(2) }.to change { lists }.to an_array_excluding(2)
    expect { lists.delete(2) }.to change { lists }.to contain_exactly(1, 3)
  end
end
```

これだけでOKです。
listsは変更されて、2が含まれなくなることを検証できます。
